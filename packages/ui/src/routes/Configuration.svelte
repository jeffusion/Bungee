<script lang="ts">
  import { onMount } from 'svelte';
  import { getConfig, updateConfig, validateConfig } from '../lib/api/config';
  import { reloadSystem, restartSystem } from '../lib/api/system';
  import { toast } from '../lib/stores/toast';
  import type { AppConfig } from '../lib/types';

  let config: AppConfig | null = null;
  let editingConfig: AppConfig | null = null;
  let error: string | null = null;
  let loading = true;
  let reloading = false;
  let restarting = false;
  let saving = false;
  let editMode: 'form' | 'json' = 'form';
  let jsonText = '';
  let jsonError: string | null = null;
  let hasChanges = false;
  let showRestartModal = false;

  async function loadConfig() {
    try {
      config = await getConfig();
      editingConfig = JSON.parse(JSON.stringify(config)); // Deep clone
      jsonText = JSON.stringify(config, null, 2);
      hasChanges = false;
      error = null;
    } catch (e: any) {
      error = e.message;
    } finally {
      loading = false;
    }
  }

  function handleFormChange() {
    hasChanges = true;
    if (editingConfig) {
      jsonText = JSON.stringify(editingConfig, null, 2);
    }
  }

  function handleJsonChange() {
    hasChanges = true;
    jsonError = null;
    try {
      editingConfig = JSON.parse(jsonText);
    } catch (e: any) {
      jsonError = e.message;
    }
  }

  async function handleSave() {
    if (!editingConfig) return;

    saving = true;
    try {
      // 验证配置
      const validation = await validateConfig(editingConfig);
      if (!validation.valid) {
        toast.show(`配置验证失败: ${validation.error}`, 'error');
        return;
      }

      // 保存配置
      const result = await updateConfig(editingConfig);
      if (result.success) {
        toast.show('配置已保存', 'success');
        config = JSON.parse(JSON.stringify(editingConfig));
        hasChanges = false;
      } else {
        toast.show(`保存失败: ${result.message}`, 'error');
      }
    } catch (e: any) {
      toast.show(`保存失败: ${e.message}`, 'error');
    } finally {
      saving = false;
    }
  }

  function handleReset() {
    if (!config) return;
    editingConfig = JSON.parse(JSON.stringify(config));
    jsonText = JSON.stringify(config, null, 2);
    hasChanges = false;
    jsonError = null;
  }

  function handleExport() {
    if (!config) return;
    const dataStr = JSON.stringify(config, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = `bungee-config-${new Date().toISOString().split('T')[0]}.json`;

    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    toast.show('配置已导出', 'success');
  }

  function handleImport() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async (e: any) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const imported = JSON.parse(text);
        editingConfig = imported;
        jsonText = JSON.stringify(imported, null, 2);
        hasChanges = true;
        toast.show('配置已导入', 'success');
      } catch (err: any) {
        toast.show(`导入失败: ${err.message}`, 'error');
      }
    };
    input.click();
  }

  async function handleReload() {
    reloading = true;
    try {
      const result = await reloadSystem();
      if (result.success) {
        toast.show('配置已成功重新加载', 'success');
        await loadConfig();
      } else {
        toast.show(`重新加载失败: ${result.message}`, 'error');
      }
    } catch (e: any) {
      toast.show(`重新加载失败: ${e.message}`, 'error');
    } finally {
      reloading = false;
    }
  }

  async function handleRestart() {
    showRestartModal = false;
    restarting = true;
    try {
      const result = await restartSystem();
      if (result.success) {
        toast.show('重启信号已发送，服务将在几秒后重启', 'success');
      } else {
        // 显示详细的错误信息
        if (result.error && result.error.includes('daemon mode')) {
          toast.show('重启功能仅在 daemon 模式下可用。请使用 "bungee restart" 命令或手动重启开发服务器。', 'error', 8000);
        } else {
          toast.show(`重启失败: ${result.error || result.message}`, 'error');
        }
      }
    } catch (e: any) {
      toast.show(`重启失败: ${e.message}`, 'error');
    } finally {
      restarting = false;
    }
  }

  onMount(() => {
    loadConfig();
  });
</script>

<div class="p-6">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold">Configuration</h1>
      <p class="text-sm text-gray-500 mt-1">
        Edit and manage system configuration
      </p>
    </div>
    <div class="flex gap-2">
      <button
        class="btn btn-outline btn-sm"
        on:click={handleExport}
        disabled={loading || !config}
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        Export
      </button>
      <button
        class="btn btn-outline btn-sm"
        on:click={handleImport}
        disabled={loading}
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
        </svg>
        Import
      </button>
      <button
        class="btn btn-primary btn-sm"
        on:click={handleReload}
        disabled={reloading || loading}
      >
        {#if reloading}
          <span class="loading loading-spinner loading-xs"></span>
        {:else}
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
        {/if}
        Reload
      </button>
      <button
        class="btn btn-warning btn-sm"
        on:click={() => showRestartModal = true}
        disabled={restarting || loading}
      >
        {#if restarting}
          <span class="loading loading-spinner loading-xs"></span>
        {:else}
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
        {/if}
        Restart Service
      </button>
    </div>
  </div>

  {#if loading}
    <div class="flex justify-center items-center h-64">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  {:else if error}
    <div class="alert alert-error">
      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <span>Error: {error}</span>
    </div>
  {:else if editingConfig}
    <!-- Mode Tabs -->
    <div class="tabs tabs-boxed mb-4">
      <button
        class="tab"
        class:tab-active={editMode === 'form'}
        on:click={() => editMode = 'form'}
      >
        Form Editor
      </button>
      <button
        class="tab"
        class:tab-active={editMode === 'json'}
        on:click={() => editMode = 'json'}
      >
        JSON Editor
      </button>
    </div>

    {#if editMode === 'form'}
      <!-- Form Editor -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">System Settings</h2>

          <!-- Server Settings -->
          <div class="form-control">
            <label class="label">
              <span class="label-text">Server Port</span>
            </label>
            <input
              type="number"
              class="input input-bordered"
              bind:value={editingConfig.port}
              on:input={handleFormChange}
              placeholder="8088"
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Worker Processes</span>
            </label>
            <input
              type="number"
              class="input input-bordered"
              bind:value={editingConfig.workers}
              on:input={handleFormChange}
              min="1"
              placeholder="2"
            />
            <label class="label">
              <span class="label-text-alt">Number of worker processes to spawn</span>
            </label>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Log Level</span>
            </label>
            <select
              class="select select-bordered"
              bind:value={editingConfig.logLevel}
              on:change={handleFormChange}
            >
              <option value="debug">Debug</option>
              <option value="info">Info</option>
              <option value="warn">Warning</option>
              <option value="error">Error</option>
            </select>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Body Parser Limit</span>
            </label>
            <input
              type="text"
              class="input input-bordered"
              bind:value={editingConfig.bodyParserLimit}
              on:input={handleFormChange}
              placeholder="50mb"
            />
            <label class="label">
              <span class="label-text-alt">Maximum request body size (e.g., "50mb", "100kb")</span>
            </label>
          </div>

          <div class="divider"></div>

          <div class="alert alert-warning">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <span>
              <strong>Note:</strong> Changes to Port, Workers, Log Level, and Body Parser Limit require a service restart to take effect.
            </span>
          </div>

          <div class="divider"></div>

          <div class="alert alert-info">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>
              <strong>{editingConfig.routes.length}</strong> routes configured.
              Use the <a href="/__ui/#/routes" class="link">Routes</a> page to manage routes.
            </span>
          </div>
        </div>
      </div>
    {:else}
      <!-- JSON Editor -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">JSON Configuration</h2>

          {#if jsonError}
            <div class="alert alert-error mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>JSON Parse Error: {jsonError}</span>
            </div>
          {/if}

          <textarea
            class="textarea textarea-bordered font-mono text-sm h-96"
            bind:value={jsonText}
            on:input={handleJsonChange}
            placeholder="Enter JSON configuration..."
          ></textarea>

          <p class="text-sm text-gray-500 mt-2">
            Edit the raw JSON configuration. Changes will be validated before saving.
          </p>
        </div>
      </div>
    {/if}

    <!-- Action Buttons -->
    {#if hasChanges}
      <div class="card bg-base-100 shadow-xl mt-4">
        <div class="card-body">
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-warning" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <span class="text-sm">You have unsaved changes</span>
            </div>
            <div class="flex gap-2">
              <button
                class="btn btn-ghost btn-sm"
                on:click={handleReset}
                disabled={saving}
              >
                Reset
              </button>
              <button
                class="btn btn-primary btn-sm"
                on:click={handleSave}
                disabled={saving || !!jsonError}
              >
                {#if saving}
                  <span class="loading loading-spinner loading-xs"></span>
                {/if}
                Save Configuration
              </button>
            </div>
          </div>
        </div>
      </div>
    {/if}
  {/if}

  <!-- Restart Confirmation Modal -->
  <input type="checkbox" bind:checked={showRestartModal} class="modal-toggle" />
  <div class="modal" class:modal-open={showRestartModal}>
    <div class="modal-box">
      <h3 class="font-bold text-lg">Confirm Service Restart</h3>
      <p class="py-4">
        Are you sure you want to restart the service? This will cause a brief interruption (typically 2-3 seconds) as the service gracefully restarts.
      </p>
      <div class="alert alert-warning">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <span>Active connections may be temporarily interrupted.</span>
      </div>
      <div class="modal-action">
        <button class="btn btn-ghost" on:click={() => showRestartModal = false}>
          Cancel
        </button>
        <button class="btn btn-warning" on:click={handleRestart}>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Restart Service
        </button>
      </div>
    </div>
  </div>
</div>
